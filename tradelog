#!/bin/sh

export POSIXLY_CORRECT=yes
export LC_NUMERIC=en_US.UTF-8

print_help()
{
  echo "Usage: tradelog [-h|--help]"
	echo "       tradelog [FILTR] [PŘÍKAZ] [LOG [LOG2 [...]]"
	echo ""
}



COMMAND=""
WIDTH=0
TICKER=""
DATE_BEFORE="9999-12-31 23:59:59"
DATE_AFTER="0000-00-00 00:00:00"
LOG_FILES=""
TFLAG=""
DAFLAG=""
DBFLAG=""
WCOUNT=0
NOPTARG=""
PROFIT=0.00

while getopts w:t:a:b:h-: opts
do case "$opts" in
   a) DAFLAG=1
      NOPTARG=$(echo "$OPTARG" | sed 's/-//g ; s/://g ; s/ //g')
      NDATE_AFTER=$(echo "$DATE_AFTER" | sed 's/-//g ; s/://g ; s/ //g' )
      if [ $NOPTARG -gt $NDATE_AFTER ]; then
        DATE_AFTER="$OPTARG"
      fi ;;

   b) DBFLAG=1
      NOPTARG=$(echo "$OPTARG" | sed 's/-//g ; s/://g ; s/ //g')
      NDATE_BEFORE=$(echo "$DATE_BEFORE" | sed 's/-//g ; s/://g ; s/ //g' )
      if [ $NOPTARG -lt $NDATE_BEFORE ]; then
        DATE_BEFORE="$OPTARG"
      fi ;;
   t) TICKER="$TICKER$OPTARG;"
      TFLAG=1;;
   w) WCOUNT=$(( $WCOUNT + 1 ))
      if [ "$WCOUNT" = 2 ]; then
          echo "Chybne spusteni"
          exit 1;
      fi
     WIDTH="$OPTARG";;
   h) print_help
      exit 0;;
   -) print_help
      exit 0;;
   *) echo "Invalid flag"
      exit 1;;
   esac
done

shift $(($OPTIND - 1))

while [ "$#" -gt 0 ]; do
  case "$1" in
  list-tick | profit | pos | last-price | hist-ord | graph-pos)
    COMMAND="$1"
    shift
    ;;
  *.log.gz)
    LOG_FILES="$LOG_FILES$(gzip -d -c "$1")\n"
    shift
    ;;
  *.log)
    LOG_FILES="$LOG_FILES$(cat "$1")\n"
    shift
    ;;
  *)
    echo "Invalid argument"
    exit 1
    ;;
  esac
done



if [ "$TFLAG" = "1" ]; then
    LOG_FILES=$(echo "$LOG_FILES" | awk -F ';' -v ticker="$TICKER" 'ticker~ $2";" {print}')
fi
if [ "$DAFLAG" = "1" ]; then
    LOG_FILES=$(echo "$LOG_FILES" | awk -F ';' -v after="$DATE_AFTER" '$1 > after {print}')
fi
if [ "$DBFLAG" = "1" ]; then
    LOG_FILES=$(echo "$LOG_FILES" | awk -F ';' -v before="$DATE_BEFORE" '$1 < before {print}')
fi
if [ "$COMMAND" = "list-tick" ]; then
    LOG_FILES=$(echo "$LOG_FILES" | awk -F ';' '{print $2}' | sort -u | sed '/./,$!d')
fi
if [ "$COMMAND" = "profit" ]; then
  PROFIT=$(echo "$LOG_FILES" | awk -F ';' '{if ($3=="sell"){ q1+=+$4*$6} else{ q2+=$4*$6}} END {printf("%.2f\n", q1-q2)}')
  echo "$PROFIT"
  exit 0;
fi

if [ "$COMMAND" = "last-price" ]; then
    LOG_FILES=$(echo "$LOG_FILES" | sed '1!G;h;$!d' | awk -F ";" '{print$2":"$4}' | sort -t: -u -k 1,1 | sed '1d')
        longestNum=0
        longestNum=$(echo "$LOG_FILES" | awk -F  ":" '{num=sprintf($2)
        if(length(num) > longestNum)
        {
          longestNum=length(num)
        }
        } END {print longestNum}')
        LOG_FILES=$(echo "$LOG_FILES" | awk -F ":" -v lN="$longestNum" '{printf("%-9s : %*s\n", $1, lN, $2)}')

fi

if [ "$COMMAND" = "hist-ord" ]; then
  LOG_FILES=$(echo "$LOG_FILES" | awk -F ';' '{print$2}'| sort | sed '1d' | uniq -c | awk -v width="$WIDTH" '{ count=sprintf($1);sy="#";
if (width!=0 && int(count) > width) {

    count=width
    #print count
  };str=sprintf("%*c",count,sy); gsub(" ",sy,str); printf("%-9s : %s\n", $2, str)}')
fi

if [ "$COMMAND" = "pos" ]; then
  LOG_FILES=$(echo "$LOG_FILES" | awk -F ';' '{print$2" "$3" "$6}'| sort | sed '1d' | awk '{ seen[$1" "$2] += $3 } END { for (i in seen) print i, seen[i] }')
fi
        echo "$LOG_FILES"

#2)Должен описовать зазнымы если не дано ни приказов ни фильтров при этом он может получить на вход не название файла
#а уже его содержимое
#3)пос находим сумму всех позиций а потом селлим их / баем их (селл минус бай плюс)
#4)Выволд ошбки если вызван препинач без параметров
#6) Закинуть все в функции отдельные
#7)Chyba kdyz WIDTH < 0
#8) Разобрать hash map чтобы сделать пос уже
